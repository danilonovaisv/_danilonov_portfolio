{"version":3,"sources":["../../../../src/lib/supabase/storage.ts","../../../../src/lib/supabase/asset-paths.ts"],"sourcesContent":["import { createClientComponentClient } from '@/lib/supabase/client';\nimport { buildAssetFilePath } from '@/lib/supabase/asset-paths';\nimport { normalizeStoragePath } from '@/lib/supabase/urls';\n\ntype UploadBucket = 'portfolio-media' | 'site-assets';\n\nfunction buildPath(base: string, slug: string) {\n  const sanitizedBase = base.replace(/\\/+$/g, '').replace(/^\\/+/g, '');\n  const basePath = sanitizedBase ? `${sanitizedBase}` : '';\n  return basePath ? `${basePath}/${slug}` : slug;\n}\n\nexport async function uploadToBucket(\n  bucket: UploadBucket,\n  basePath: string,\n  identifier: string,\n  file: File\n) {\n  const supabase = createClientComponentClient();\n  const ext = file.name.split('.').pop();\n  const name = ext ? `${identifier}.${ext}` : identifier;\n  const path = buildPath(basePath, name);\n  const { data, error } = await supabase.storage\n    .from(bucket)\n    .upload(path, file, { cacheControl: '3600', upsert: true });\n\n  if (error) throw error;\n  return normalizeStoragePath(data.path, bucket);\n}\n\nexport async function uploadSiteAsset({\n  file,\n  key,\n  page,\n  subPath,\n  bucket = 'site-assets',\n}: {\n  file: File;\n  key: string;\n  page?: string | null;\n  subPath?: string;\n  bucket?: UploadBucket;\n}) {\n  const supabase = createClientComponentClient();\n  const extension = file.name.split('.').pop() ?? 'bin';\n  const path = buildAssetFilePath({\n    page,\n    key,\n    subPath,\n    extension,\n  });\n\n  const { data, error } = await supabase.storage\n    .from(bucket)\n    .upload(path, file, { cacheControl: '3600', upsert: true });\n\n  if (error) throw error;\n  return normalizeStoragePath(data.path, bucket);\n}\n","const VALID_KEY_CHARS = /[^a-z0-9._-]/g;\n\nexport function sanitizeAssetKey(key: string) {\n  return key\n    .trim()\n    .toLowerCase()\n    .replace(/\\s+/g, '_')\n    .replace(VALID_KEY_CHARS, '');\n}\n\nexport function normalizePage(page?: string | null) {\n  return page && page.trim().length > 0 ? page.trim() : 'global';\n}\n\nexport function buildAssetFilePath({\n  page,\n  key,\n  subPath,\n  extension,\n}: {\n  page?: string | null;\n  key: string;\n  subPath?: string;\n  extension: string;\n}) {\n  const targetPage = normalizePage(page);\n  const segments = [targetPage];\n  if (subPath) {\n    segments.push(subPath.trim().replace(/^\\/+|\\/+$/g, ''));\n  }\n\n  const sanitizedKey = sanitizeAssetKey(key);\n  const normalizedExtension =\n    extension.toLowerCase().replace(/^\\.+/, '') || 'bin';\n  const fileName = `${sanitizedKey}.${normalizedExtension}`;\n  return `${segments.join('/')}/${fileName}`;\n}\n\nexport function getFileExtension(filePath: string | null | undefined) {\n  if (!filePath) return '';\n  const parts = filePath.split('.');\n  if (parts.length <= 1) return '';\n  return parts.pop() ?? '';\n}\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OCAA,IAAM,EAAkB,gBDExB,IAAA,EAAA,EAAA,CAAA,CAAA,OAUO,eAAe,EACpB,CAAoB,CACpB,CAAgB,CAChB,CAAkB,CAClB,CAAU,EAEV,QAAM,EAAW,CAAA,EAAA,EAAA,2BAAA,AAA2B,IACtC,EAAM,EAAK,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,GAC9B,EAAO,EAAM,CAAA,EAAG,EAAW,CAAC,EAAE,EAAA,CAAK,CAAG,EACtC,EAZC,CADD,EAAW,CADX,CAcO,CAdS,AAcC,EAdI,OAAO,CAAC,QAAS,IAAI,OAAO,CAAC,QAAS,KAChC,CAAA,EAAG,EAAA,CAAe,CAAG,IACpC,CAAA,EAAG,EAAS,CAAC,EAAE,EAAA,CAAM,CAYN,EAZS,AAapC,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,OAAO,CAC3C,IAAI,CAAC,GACL,MAAM,CAAC,EAAM,EAAM,CAAE,aAAc,OAAQ,QAAQ,CAAK,GAE3D,GAAI,EAAO,MAAM,EACjB,MAAO,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAC,EAAK,IAAI,CAAE,EACzC,CAEO,eAAe,EAAgB,MACpC,CAAI,KACJ,CAAG,MACH,CAAI,SACJ,CAAO,QACP,EAAS,aAAa,CAOvB,EACC,IAAM,EAAW,CAAA,EAAA,EAAA,2BAAA,AAA2B,IAEtC,EC/BD,AD+BQ,SC/BC,AAAmB,MACjC,CAAI,CACJ,KAAG,SACH,CAAO,WACP,CAAS,CAMV,EAEC,IAAM,EAAW,CAfV,GAc0B,AAdlB,EAAK,IAAI,GAAG,MAAM,CAAG,EAAI,EAAK,IAAI,GAAK,SAezB,CACzB,GACF,EAAS,IADE,AACE,CAAC,EAAQ,IAAI,GAAG,OAAO,CAAC,aAAc,KAGrD,IAAM,EAAgC,AA5B/B,EACJ,IAAI,GACJ,IA0BkB,OA1BP,GACX,OAAO,CAAC,OAAQ,KAChB,OAAO,CAAC,EAAiB,IAyBtB,EACJ,EAAU,WAAW,GAAG,OAAO,CAAC,OAAQ,KAAO,MAC3C,EAAW,CAAA,EAAG,EAAa,CAAC,EAAE,EAAA,CAAqB,CACzD,MAAO,CAAA,EAAG,EAAS,IAAI,CAAC,KAAK,CAAC,EAAE,EAAA,CAAU,AAC5C,EDSkC,MAC9B,MACA,UACA,EACA,UALgB,EAAK,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,IAAM,KAMhD,GAEM,CAAE,MAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,OAAO,CAC3C,IAAI,CAAC,GACL,MAAM,CAAC,EAAM,EAAM,CAAE,aAAc,OAAQ,QAAQ,CAAK,GAE3D,GAAI,EAAO,MAAM,EACjB,MAAO,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAC,EAAK,IAAI,CAAE,EACzC"}