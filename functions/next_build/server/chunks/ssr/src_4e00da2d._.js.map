{"version":3,"sources":["../../../../src/lib/supabase/storage.ts","../../../../src/lib/supabase/asset-paths.ts","../../../../src/components/admin/ProjectForm.tsx"],"sourcesContent":["import { createClientComponentClient } from '@/lib/supabase/client';\nimport { buildAssetFilePath } from '@/lib/supabase/asset-paths';\nimport { normalizeStoragePath } from '@/lib/supabase/urls';\n\ntype UploadBucket = 'portfolio-media' | 'site-assets';\n\nfunction buildPath(base: string, slug: string) {\n  const sanitizedBase = base.replace(/\\/+$/g, '').replace(/^\\/+/g, '');\n  const basePath = sanitizedBase ? `${sanitizedBase}` : '';\n  return basePath ? `${basePath}/${slug}` : slug;\n}\n\nexport async function uploadToBucket(\n  bucket: UploadBucket,\n  basePath: string,\n  identifier: string,\n  file: File\n) {\n  const supabase = createClientComponentClient();\n  const ext = file.name.split('.').pop();\n  const name = ext ? `${identifier}.${ext}` : identifier;\n  const path = buildPath(basePath, name);\n  const { data, error } = await supabase.storage\n    .from(bucket)\n    .upload(path, file, { cacheControl: '3600', upsert: true });\n\n  if (error) throw error;\n  return normalizeStoragePath(data.path, bucket);\n}\n\nexport async function uploadSiteAsset({\n  file,\n  key,\n  page,\n  subPath,\n  bucket = 'site-assets',\n}: {\n  file: File;\n  key: string;\n  page?: string | null;\n  subPath?: string;\n  bucket?: UploadBucket;\n}) {\n  const supabase = createClientComponentClient();\n  const extension = file.name.split('.').pop() ?? 'bin';\n  const path = buildAssetFilePath({\n    page,\n    key,\n    subPath,\n    extension,\n  });\n\n  const { data, error } = await supabase.storage\n    .from(bucket)\n    .upload(path, file, { cacheControl: '3600', upsert: true });\n\n  if (error) throw error;\n  return normalizeStoragePath(data.path, bucket);\n}\n","const VALID_KEY_CHARS = /[^a-z0-9._-]/g;\n\nexport function sanitizeAssetKey(key: string) {\n  return key\n    .trim()\n    .toLowerCase()\n    .replace(/\\s+/g, '_')\n    .replace(VALID_KEY_CHARS, '');\n}\n\nexport function normalizePage(page?: string | null) {\n  return page && page.trim().length > 0 ? page.trim() : 'global';\n}\n\nexport function buildAssetFilePath({\n  page,\n  key,\n  subPath,\n  extension,\n}: {\n  page?: string | null;\n  key: string;\n  subPath?: string;\n  extension: string;\n}) {\n  const targetPage = normalizePage(page);\n  const segments = [targetPage];\n  if (subPath) {\n    segments.push(subPath.trim().replace(/^\\/+|\\/+$/g, ''));\n  }\n\n  const sanitizedKey = sanitizeAssetKey(key);\n  const normalizedExtension =\n    extension.toLowerCase().replace(/^\\.+/, '') || 'bin';\n  const fileName = `${sanitizedKey}.${normalizedExtension}`;\n  return `${segments.join('/')}/${fileName}`;\n}\n\nexport function getFileExtension(filePath: string | null | undefined) {\n  if (!filePath) return '';\n  const parts = filePath.split('.');\n  if (parts.length <= 1) return '';\n  return parts.pop() ?? '';\n}\n","'use client';\n\nimport { useState, useTransition } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { useForm, type Resolver, type SubmitHandler } from 'react-hook-form';\nimport { z } from 'zod';\n\nimport { createClientComponentClient } from '@/lib/supabase/client';\nimport { uploadToBucket } from '@/lib/supabase/storage';\nimport type { DbProject, DbTag, DbLandingPage } from '@/types/admin';\n\nconst projectSchema = z.object({\n  title: z.string().min(3),\n  slug: z.string().min(3),\n  client_name: z.string().min(2),\n  brand_name: z.string().optional(),\n  year: z.coerce.number().int().optional(),\n  project_type: z.string().min(2),\n  short_label: z.string().optional(),\n  description: z.string().optional(),\n  featured_on_home: z.boolean().optional(),\n  featured_on_portfolio: z.boolean().optional(),\n  featured_home_order: z.coerce.number().int().optional().nullable(),\n  featured_portfolio_order: z.coerce.number().int().optional().nullable(),\n  is_published: z.boolean().optional(),\n  landing_page_id: z.string().optional().nullable(),\n  tags: z.array(z.string()).optional(),\n});\n\ntype FormValues = z.infer<typeof projectSchema>;\n\ntype Props = {\n  project?: DbProject;\n  tags: DbTag[];\n  landingPages: Pick<DbLandingPage, 'id' | 'title' | 'slug'>[];\n  selectedTagIds?: string[];\n};\n\nexport function ProjectForm({\n  project,\n  tags,\n  landingPages,\n  selectedTagIds = [],\n}: Props) {\n  const [thumbnail, setThumbnail] = useState<File | null>(null);\n  const [hero, setHero] = useState<File | null>(null);\n  const [gallery, setGallery] = useState<File[]>([]);\n  const [error, setError] = useState<string | null>(null);\n  const [isPending, startTransition] = useTransition();\n  const router = useRouter();\n\n  const form = useForm<FormValues>({\n    resolver: zodResolver(projectSchema) as Resolver<FormValues>,\n    defaultValues: {\n      title: project?.title ?? '',\n      slug: project?.slug ?? '',\n      client_name: project?.client_name ?? '',\n      brand_name: project?.brand_name ?? '',\n      year: project?.year ?? undefined,\n      project_type: project?.project_type ?? 'Branding & Identity',\n      short_label: project?.short_label ?? '',\n      description: project?.description ?? '',\n      featured_on_home: project?.featured_on_home ?? false,\n      featured_on_portfolio: project?.featured_on_portfolio ?? false,\n      featured_home_order: project?.featured_home_order ?? undefined,\n      featured_portfolio_order: project?.featured_portfolio_order ?? undefined,\n      is_published: project?.is_published ?? true,\n      landing_page_id: project?.landing_page_id ?? '',\n      tags: selectedTagIds,\n    },\n  });\n\n  const selectedTags = form.watch('tags') || [];\n\n  const onSubmit: SubmitHandler<FormValues> = (values) => {\n    setError(null);\n    startTransition(async () => {\n      try {\n        const supabase = createClientComponentClient();\n        let thumbnail_path = project?.thumbnail_path ?? null;\n        let hero_image_path = project?.hero_image_path ?? null;\n        const galleryEntries: Array<{ path: string }> = Array.isArray(\n          project?.gallery\n        )\n          ? project?.gallery?.map((item) => ({ path: item.path }))\n          : [];\n\n        if (thumbnail) {\n          thumbnail_path = await uploadToBucket(\n            'portfolio-media',\n            `projects/${values.slug}`,\n            'thumb',\n            thumbnail\n          );\n        }\n\n        if (hero) {\n          hero_image_path = await uploadToBucket(\n            'portfolio-media',\n            `projects/${values.slug}`,\n            'hero',\n            hero\n          );\n        }\n\n        if (gallery.length > 0) {\n          for (const file of gallery) {\n            const path = await uploadToBucket(\n              'portfolio-media',\n              `projects/${values.slug}/gallery`,\n              file.name.replace(/\\W+/g, '-'),\n              file\n            );\n            if (path) {\n              galleryEntries.push({ path });\n            }\n          }\n        }\n\n        const { tags: formTags = [], ...payloadData } = values;\n\n        // Clean landing_page_id to be null if empty string\n        if (payloadData.landing_page_id === '') {\n          payloadData.landing_page_id = null;\n        }\n\n        const { data, error: upsertError } = await supabase\n          .from('portfolio_projects')\n          .upsert(\n            {\n              id: project?.id,\n              ...payloadData,\n              gallery: galleryEntries,\n              thumbnail_path,\n              hero_image_path,\n            },\n            { onConflict: 'id' }\n          )\n          .select()\n          .single();\n\n        if (upsertError) throw upsertError;\n\n        if (data?.id) {\n          await supabase\n            .from('portfolio_project_tags')\n            .delete()\n            .eq('project_id', data.id);\n          const tagIds = formTags.length > 0 ? formTags : selectedTags;\n          if (tagIds.length > 0) {\n            await supabase.from('portfolio_project_tags').insert(\n              tagIds.map((tagId) => ({\n                project_id: data.id,\n                tag_id: tagId,\n              }))\n            );\n          }\n        }\n\n        router.push('/admin/trabalhos');\n        router.refresh();\n      } catch (err) {\n        setError(\n          err instanceof Error ? err.message : 'Ocorreu um erro desconhecido'\n        );\n      }\n    });\n  };\n\n  return (\n    <form className=\"space-y-6\" onSubmit={form.handleSubmit(onSubmit)}>\n      <div className=\"grid gap-4 md:grid-cols-2\">\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Título</span>\n          <input\n            className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n            {...form.register('title')}\n          />\n        </label>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Slug</span>\n          <div className=\"flex flex-col gap-2\">\n            {tags.length > 0 && (\n              <select\n                className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm text-slate-200\"\n                defaultValue=\"\"\n                onChange={(event) => {\n                  const selectedSlug = event.target.value;\n                  if (selectedSlug) {\n                    form.setValue('slug', selectedSlug);\n                  }\n                }}\n              >\n                <option value=\"\">Usar slug das tags existentes</option>\n                {tags.map((tag) => (\n                  <option key={tag.id} value={tag.slug}>\n                    {tag.label} — {tag.slug}\n                  </option>\n                ))}\n              </select>\n            )}\n            <input\n              className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n              {...form.register('slug')}\n            />\n          </div>\n        </label>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Cliente</span>\n          <input\n            className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n            {...form.register('client_name')}\n          />\n        </label>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Marca</span>\n          <input\n            className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n            {...form.register('brand_name')}\n          />\n        </label>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Ano</span>\n          <input\n            type=\"number\"\n            className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n            {...form.register('year')}\n          />\n        </label>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Tipo de projeto</span>\n          <select\n            className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n            {...form.register('project_type')}\n          >\n            <option>Branding & Identity</option>\n            <option>Campanhas & Advertising</option>\n            <option>Web & Digital</option>\n            <option>Motion & Video</option>\n            <option>Institucional & Retail</option>\n          </select>\n        </label>\n        <label className=\"flex flex-col gap-2 md:col-span-2\">\n          <span className=\"text-sm text-slate-300\">Short label</span>\n          <input\n            className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n            {...form.register('short_label')}\n          />\n        </label>\n        <label className=\"flex flex-col gap-2 md:col-span-2\">\n          <span className=\"text-sm text-slate-300\">Descrição</span>\n          <textarea\n            rows={4}\n            className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n            {...form.register('description')}\n          />\n        </label>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <label className=\"flex items-center gap-2 text-sm text-slate-300\">\n          <input type=\"checkbox\" {...form.register('featured_on_home')} />\n          Destaque Home\n        </label>\n        <label className=\"flex items-center gap-2 text-sm text-slate-300\">\n          <input type=\"checkbox\" {...form.register('featured_on_portfolio')} />\n          Destaque Portfólio\n        </label>\n        <label className=\"flex items-center gap-2 text-sm text-slate-300\">\n          <input type=\"checkbox\" {...form.register('is_published')} />\n          Publicado\n        </label>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Ordem Home</span>\n          <input\n            type=\"number\"\n            className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n            {...form.register('featured_home_order')}\n          />\n        </label>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Ordem Portfólio</span>\n          <input\n            type=\"number\"\n            className=\"rounded-md bg-slate-900/60 border border-white/10 px-3 py-2 text-sm\"\n            {...form.register('featured_portfolio_order')}\n          />\n        </label>\n      </div>\n\n      <div className=\"p-6 bg-blue-600/5 border border-blue-600/10 rounded-xl space-y-4\">\n        <h3 className=\"text-sm font-bold uppercase tracking-widest text-blue-400\">\n          Página de Destino (Link Interno)\n        </h3>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-xs text-slate-400\">\n            Selecione uma Landing Page para este trabalho\n          </span>\n          <select\n            className=\"rounded-md bg-slate-900 border border-white/10 px-3 py-2 text-sm text-white\"\n            {...form.register('landing_page_id')}\n          >\n            <option value=\"\">Nenhuma (Default)</option>\n            {landingPages.map((lp) => (\n              <option key={lp.id} value={lp.id}>\n                {lp.title} (/{lp.slug})\n              </option>\n            ))}\n          </select>\n          <p className=\"text-[10px] text-slate-500 italic\">\n            Quando vinculado, o clique no trabalho abrirá a Landing Page\n            customizada em vez de uma visualização padrão.\n          </p>\n        </label>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Thumbnail</span>\n          <input\n            type=\"file\"\n            accept=\"image/*,video/*\"\n            onChange={(e) => setThumbnail(e.target.files?.[0] ?? null)}\n          />\n          {project?.thumbnail_path && (\n            <span className=\"text-xs text-slate-400 break-all\">\n              {project.thumbnail_path}\n            </span>\n          )}\n        </label>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Hero image</span>\n          <input\n            type=\"file\"\n            accept=\"image/*\"\n            onChange={(e) => setHero(e.target.files?.[0] ?? null)}\n          />\n          {project?.hero_image_path && (\n            <span className=\"text-xs text-slate-400 break-all\">\n              {project.hero_image_path}\n            </span>\n          )}\n        </label>\n        <label className=\"flex flex-col gap-2\">\n          <span className=\"text-sm text-slate-300\">Galeria</span>\n          <input\n            type=\"file\"\n            accept=\"image/*,video/*\"\n            multiple\n            onChange={(e) => setGallery(Array.from(e.target.files ?? []))}\n          />\n          {Array.isArray(project?.gallery) && project.gallery.length > 0 && (\n            <span className=\"text-xs text-slate-400\">\n              {project.gallery.length} itens já cadastrados\n            </span>\n          )}\n        </label>\n      </div>\n\n      <div>\n        <p className=\"text-sm text-slate-300 mb-2\">Tags</p>\n        <div className=\"flex flex-wrap gap-3\">\n          {tags.map((tag) => (\n            <label\n              key={tag.id}\n              className=\"flex items-center gap-2 text-sm text-slate-200\"\n            >\n              <input\n                type=\"checkbox\"\n                value={tag.id}\n                checked={selectedTags.includes(tag.id)}\n                onChange={(e) => {\n                  const { checked, value } = e.target;\n                  if (checked) {\n                    form.setValue('tags', [...selectedTags, value]);\n                  } else {\n                    form.setValue(\n                      'tags',\n                      selectedTags.filter((id) => id !== value)\n                    );\n                  }\n                }}\n              />\n              {tag.label}\n            </label>\n          ))}\n        </div>\n      </div>\n\n      {error && <div className=\"text-sm text-red-400\">{error}</div>}\n\n      <button\n        type=\"submit\"\n        className=\"inline-flex items-center justify-center rounded-md bg-blue-500 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-blue-600 disabled:opacity-50\"\n        disabled={isPending}\n      >\n        {isPending ? 'Salvando...' : 'Salvar projeto'}\n      </button>\n    </form>\n  );\n}\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OCAA,IAAM,EAAkB,gBDExB,IAAA,EAAA,EAAA,CAAA,CAAA,OAUO,eAAe,EACpB,CAAoB,CACpB,CAAgB,CAChB,CAAkB,CAClB,CAAU,EAEV,QAAM,EAAW,CAAA,EAAA,EAAA,2BAAA,AAA2B,IACtC,EAAM,EAAK,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,GAC9B,EAAO,EAAM,CAAA,EAAG,EAAW,CAAC,EAAE,EAAA,CAAK,CAAG,EACtC,EAZC,CADD,EAAW,CADX,CAcO,CAdS,AAcC,EAdI,OAAO,CAAC,QAAS,IAAI,OAAO,CAAC,QAAS,KAChC,CAAA,EAAG,EAAA,CAAe,CAAG,IACpC,CAAA,EAAG,EAAS,CAAC,EAAE,EAAA,CAAM,CAYN,EAZS,AAapC,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,OAAO,CAC3C,IAAI,CAAC,GACL,MAAM,CAAC,EAAM,EAAM,CAAE,aAAc,OAAQ,QAAQ,CAAK,GAE3D,GAAI,EAAO,MAAM,EACjB,MAAO,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAC,EAAK,IAAI,CAAE,EACzC,CAEO,eAAe,EAAgB,MACpC,CAAI,KACJ,CAAG,MACH,CAAI,CACJ,SAAO,QACP,EAAS,aAAa,CAOvB,EACC,IAAM,EAAW,CAAA,EAAA,EAAA,2BAAA,AAA2B,IAEtC,EC/BD,AD+BQ,SC/BC,AAAmB,MACjC,CAAI,CACJ,KAAG,SACH,CAAO,WACP,CAAS,CAMV,EAEC,IAAM,EAAW,CAfV,GAc0B,AAdlB,EAAK,IAAI,GAAG,MAAM,CAAG,EAAI,EAAK,IAAI,GAAK,SAezB,CACzB,GACF,EAAS,IADE,AACE,CAAC,EAAQ,IAAI,GAAG,OAAO,CAAC,aAAc,KAGrD,IAAM,EAAgC,AA5B/B,EACJ,IAAI,GACJ,IA0BkB,OA1BP,GACX,OAAO,CAAC,OAAQ,KAChB,OAAO,CAAC,EAAiB,IAyBtB,EACJ,EAAU,WAAW,GAAG,OAAO,CAAC,OAAQ,KAAO,MAC3C,EAAW,CAAA,EAAG,EAAa,CAAC,EAAE,EAAA,CAAqB,CACzD,MAAO,CAAA,EAAG,EAAS,IAAI,CAAC,KAAK,CAAC,EAAE,EAAA,CAAU,AAC5C,EDSkC,MAC9B,MACA,EACA,UACA,UALgB,EAAK,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,IAAM,KAMhD,GAEM,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,OAAO,CAC3C,IAAI,CAAC,GACL,MAAM,CAAC,EAAM,EAAM,CAAE,aAAc,OAAQ,QAAQ,CAAK,GAE3D,GAAI,EAAO,MAAM,EACjB,MAAO,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAC,EAAK,IAAI,CAAE,EACzC,gGExDA,EAAA,CAAA,CAAA,OACA,EAAA,CAAA,CAAA"}